# Example workflow demonstrating complete Lambda + Terraform + Website deployment
name: Complete Deployment Pipeline

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Step 1: Build Lambda functions for x86_64 (default)
  lambda-build-x86:
    uses: faccomichele/utils-n-scripts/.github/workflows/lambda-build.yml@latest
    with:
      working-directory: './terraform'
      # architecture: 'x86_64' # This is the default, can be omitted

  # Optional: Build Lambda functions for ARM64 (Graviton2)
  # Uncomment this job if you need ARM64 Lambda packages
  # lambda-build-arm64:
  #   uses: faccomichele/utils-n-scripts/.github/workflows/lambda-build.yml@latest
  #   with:
  #     working-directory: './terraform'
  #     architecture: 'arm64'

  # Step 2: Run Terraform plan on PR, apply on main
  terraform-plan:
    needs: lambda-build-x86  # Change to lambda-build-arm64 if using ARM64
    uses: faccomichele/utils-n-scripts/.github/workflows/terraform-run.yml@latest
    with:
      action: ${{ github.event_name == 'pull_request' && 'plan' || 'apply' }}
      environment: 'dev'
      region: 'us-west-2'
      working-directory: './terraform'
      download-lambda-artifacts: true
    secrets: inherit

  # Step 3: Deploy website (only on main after terraform apply)
  deploy-website:
    if: github.ref == 'refs/heads/main'
    needs: terraform-plan
    uses: faccomichele/utils-n-scripts/.github/workflows/deploy-website.yml@latest
    with:
      environment: 'dev'
      region: 'us-west-2'
      working-directory: 'website'
      terraform-artifact-name: 'terraform-output'
    secrets: inherit
