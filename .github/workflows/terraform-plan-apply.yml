name: Run Terraform on AWS (reusable workflow)

on:
  workflow_call:
    inputs:
      environment:
        description: 'The target environment/workspace to be used (dev, stg, prod)'
        type: string
        default: 'dev'
      region:
        description: 'The region available for the environment in AWS format embedded as a string, if applicable, i.e.: \"us-west-2\"'
        type: string
        default: 'global'
      just-plan:
        description: 'To review the changes only without applying any change, just run "plan" instead of "apply"'
        type: boolean
        default: true
      working-directory:
        description: 'The location containing the terraform related files'
        type: string
        default: "."

permissions:
  id-token: write
  pull-requests: write
  contents: read

env:
  ENVNAME: ${{ inputs.environment }}

jobs:
  terraform_plan_apply:
    name: Run Terraform (${{ inputs.environment }}_${{ inputs.region }}) - (${{ inputs.working-directory }})
    runs-on: ${{ vars.RUNNERS || 'ubuntu-latest' }}
    if: ${{ inputs.working-directory != '[]' }}
    steps:
    - name: Set branch names
      id: repo_details
      shell: bash
      run: |
        echo "repo-name=$(echo ${{ github.repository }} | cut -d "/" -f2)" | tee -a $GITHUB_OUTPUT
        echo "repo-url=$(echo ${{ github.repositoryUrl }} | sed 's/git:/https:/g' | sed 's/.git$//g')" | tee -a $GITHUB_OUTPUT

    - name: Get source code locally from this repo
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # TO DO: Hardcode the script version once stable
    - name: Get the Terraform Report Script
      shell: bash
      run: wget -O tf_out_to_md.py https://raw.githubusercontent.com/faccomichele/utils-n-scripts/refs/heads/main/terraform/tf_out_to_md.py && chmod +x tf_out_to_md.py

    - name: Setup Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: ${{ vars.PYTHON_VERSION || '3.13' }}

    - name: Define the name of the variables to be retrieved based on the target environment
      id: aws_env_ids
      shell: bash
      run: |
        echo "role=${ENVNAME^^}_AWS_GITHUB_ROLE" | tee -a $GITHUB_OUTPUT
        echo "account=${ENVNAME^^}_AWS_ID" | tee -a $GITHUB_OUTPUT
      
    - name: Retrieve the AWS IAM Role to be used
      id: aws_role
      shell: bash
      run: echo "arn=arn:aws:iam::${{ vars[ steps.aws_env_ids.outputs.account ] }}:role/${{ vars[ steps.aws_env_ids.outputs.role ] }}" | tee -a $GITHUB_OUTPUT

    - name: AWS CLI Login
      uses: aws-actions/configure-aws-credentials@d4695650384537945e0b565ee73a714d361bcb04  # v5.5.1
      with:
        role-to-assume: ${{ steps.aws_role.outputs.arn }}
        aws-region: ${{ inputs.region == 'global' && 'eu-central-1' || inputs.region  }}
        role-duration-seconds: '3600'
    
    - name: Get S3 Backend configuration for storing shared state files
      shell: bash
      env:
        REGION: ${{ vars.TF_STATE_SSM_REGION || 'eu-central-1' }}
      run: |
        VALUE=$(aws ssm get-parameter --name /terraform-core-aws/${ENVNAME}/backend_configuration_hcl --query "Parameter.Value" --output text --with-decryption --region $REGION)
        mkdir -p config
        echo "$VALUE" | awk -v r="${{ steps.repo_details.outputs.repo-name }}" '{gsub(/CHANGE_ME/, r); print}' > config/${ENVNAME}.s3.tfbackend
      
    - name: Configure Terraform
      uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # 3.1.2
      with:
        terraform_version:  ${{ vars.TF_VERSION || '1.14.3' }}
        terraform_wrapper: false

    - name: Init Terraform
      shell: bash
      run: terraform init -backend-config=config/${ENVNAME}.s3.tfbackend
      working-directory: ${{ inputs.working-directory }}

    - name: Set Terraform Workspace Name
      shell: bash
      run: |
        if [[ "${REGION}" == "global" ]]; then
          echo "name=${ENVNAME}" | tee -a $GITHUB_OUTPUT
        else
          echo "name=${ENVNAME}_${REGION}" | tee -a $GITHUB_OUTPUT
        fi
      id: workspace

    - name: Set Terraform Workspace
      shell: bash
      run: terraform workspace select -or-create ${{ steps.workspace.outputs.name }}
      working-directory: ${{ inputs.working-directory }}

    # - name: Set Tags Variable
    #   shell: bash
    #   run: |
    #     TAGS=$(echo """{
    #       \"eml:repo_name\": \"${{ inputs.repo-name }}\",
    #       \"lnrs:repo\": \"${{ inputs.repo-url }}\",
    #       \"lnrs:owner_email\": \"${{ vars.OWNER_EMAIL }}\",
    #       \"eml:repo_path\": \"${{ inputs.working-directory }}\",
    #       \"eml:repo_tmpl\": \"${{ inputs.repo-tmpl }}\"
    #     }""" | jq -c)
    #     if [[ "${{ vars.EKS_CLUSTER }}" != "" ]]; then
    #       TAGS=$(echo $TAGS "{\"eml:eks_cluster\": \"${{ vars.EKS_CLUSTER }}\"}" | jq -sc '.[0] * .[1]')
    #     fi
    #     echo "value=tags=$TAGS" | tee -a $GITHUB_OUTPUT
    #   id: tags_var

    - name: Set Terraform Options
      shell: bash
      run: |
        if [[ "${{ inputs.just-plan }}" == "true" ]]; then
          echo "action=plan -out=tfplan" | tee -a $GITHUB_OUTPUT
        else
          echo "action=apply -auto-approve" | tee -a $GITHUB_OUTPUT
        fi
        CONFIGFILE=''
        if [[ -f config/${{ steps.workspace.outputs.name }}.tfvars ]]; then
          CONFIGFILE='-var-file=config/${{ steps.workspace.outputs.name }}.tfvars'
        fi
        echo "config-file=$CONFIGFILE" | tee -a $GITHUB_OUTPUT
      working-directory: ${{ inputs.working-directory }}
      id: options

    - name: Run Terraform ${{ steps.options.outputs.action }}
      id: tf_run
      shell: bash
      env:
        ACTION: ${{ steps.options.outputs.action }}
        CONFIG_FILE: ${{ steps.options.outputs.config-file }}
        # TAGS_VAR: ${{ steps.tags_var.outputs.value }} # -var="$TAGS_VAR" \
      run: terraform $ACTION -json -no-color ${CONFIG_FILE:+$CONFIG_FILE} 2>&1 | tee tf-logs.json
      working-directory: ${{ inputs.working-directory }}

    - name: Create Show output from Plan action
      if: ${{ inputs.just-plan == 'true' }}
      shell: bash
      run: terraform show -json tfplan > tf-show.json

    - name: Run Terraform Output to MD Report
      id: tf_report
      if: always()
      shell: bash
      run: ./tf_out_to_md.py
      working-directory: ${{ inputs.working-directory }}
    
    - name: Add report to job summary
      if: always() && steps.tf_report.outcome == 'success'
      shell: bash
      run: cat ${{ inputs.working-directory }}/tf-report.md >> $GITHUB_STEP_SUMMARY
    
    - name: Prepare Terraform output for comment
      if: always() && steps.tf_report.outcome == 'success' && github.event_name == 'pull_request'
      id: tf_comment_prep
      shell: bash
      run: |
        COMMENT_BODY=""
        MD_FILE="${{ inputs.working-directory }}/tf-report.md"
        if [[ -f "$MD_FILE" ]]; then
          # Check for errors
          ERRORS=$(grep -E '^### ‚ùå Error in' "$MD_FILE" || true)
          if [[ -n "$ERRORS" ]]; then
            COMMENT_BODY+="### üö® Terraform Errors Detected"$'\n\n'
            COMMENT_BODY+=$(echo "$ERRORS" | sed 's/### ‚ùå Error in/‚ùå/g')
            COMMENT_BODY+=$'\n\n'
          fi

          # Get summary
          SUMMARY=$(awk '/## Summary/{flag=1;next}/## Detailed Changes/{flag=0}flag' "$MD_FILE")
          if [[ -n "$SUMMARY" ]]; then
            COMMENT_BODY+="### Plan Summary"$'\n'
            COMMENT_BODY+="$SUMMARY"
          fi
        else
          COMMENT_BODY="Could not find the Terraform report file."
        fi

        # Add link to job summary
        JOB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        COMMENT_BODY+=$'\n\n'
        COMMENT_BODY+="[View Full Report in Job Summary](${JOB_URL})"

        echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
        printf '%s\n' "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
      
    - name: Comment Terraform Output on PR
      if: always() && steps.tf_comment_prep.outcome == 'success' && github.event_name == 'pull_request'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v6
      env:
        COMMENT_BODY: ${{ steps.tf_comment_prep.outputs.comment_body }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issue_number = context.issue.number;
          if (!issue_number) {
            console.log('Could not determine PR number.');
            return;
          }

          const comment_title = `### Terraform Plan for \`${{ inputs.working-directory }}\` in \`${{ inputs.environment }}_${{ inputs.region }}\``;
          const comment_body = `${comment_title}

          ${process.env.COMMENT_BODY}`

          const since_date = new Date();
          since_date.setDate(since_date.getDate() - 3);

          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue_number,
            since: since_date.toISOString(),
            sort: 'updated',
            direction: 'desc'
          });

          const bot_comment = comments.find(comment => {
            return comment.user.login === 'github-actions[bot]' && comment.body.startsWith(comment_title)
          });

          if (bot_comment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: bot_comment.id,
              body: comment_body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: comment_body
            });
          }
